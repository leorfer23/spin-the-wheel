<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Store 6545032 - Widget Test</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            line-height: 1.6;
            color: #333;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .container {
            background: white;
            border-radius: 12px;
            padding: 40px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
        }
        h1 {
            color: #764ba2;
            border-bottom: 3px solid #667eea;
            padding-bottom: 10px;
            margin-bottom: 30px;
        }
        .info-box {
            background: #f8f9fa;
            border-left: 4px solid #667eea;
            padding: 15px;
            margin: 20px 0;
            border-radius: 4px;
        }
        .product-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
            margin: 30px 0;
        }
        .product-card {
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 15px;
            text-align: center;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .product-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        .product-image {
            width: 100%;
            height: 200px;
            background: linear-gradient(45deg, #f0f0f0 25%, transparent 25%, transparent 75%, #f0f0f0 75%, #f0f0f0),
                        linear-gradient(45deg, #f0f0f0 25%, transparent 25%, transparent 75%, #f0f0f0 75%, #f0f0f0);
            background-size: 20px 20px;
            background-position: 0 0, 10px 10px;
            border-radius: 4px;
            margin-bottom: 10px;
        }
        .price {
            font-size: 24px;
            color: #667eea;
            font-weight: bold;
        }
        .controls {
            background: #f0f3ff;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
        }
        .control-group {
            margin: 15px 0;
        }
        .control-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #555;
        }
        .control-group select,
        .control-group input {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        .btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            margin: 5px;
            transition: background 0.2s;
        }
        .btn:hover {
            background: #5a67d8;
        }
        .btn-danger {
            background: #e53e3e;
        }
        .btn-danger:hover {
            background: #c53030;
        }
        .status {
            padding: 10px;
            border-radius: 6px;
            margin: 10px 0;
            font-family: monospace;
            font-size: 14px;
        }
        .status.success {
            background: #c6f6d5;
            border: 1px solid #9ae6b4;
            color: #22543d;
        }
        .status.error {
            background: #fed7d7;
            border: 1px solid #fc8181;
            color: #742a2a;
        }
        .status.info {
            background: #e6fffa;
            border: 1px solid #81e6d9;
            color: #234e52;
        }
        .console-output {
            background: #1a1a1a;
            color: #0f0;
            padding: 15px;
            border-radius: 6px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
            margin-top: 20px;
        }
        .console-line {
            margin: 2px 0;
        }
        .console-line.error {
            color: #ff6b6b;
        }
        .console-line.warn {
            color: #ffd93d;
        }
        .console-line.info {
            color: #6bcf7f;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üéØ Test Store 6545032 - CoolPops Widget Test</h1>
        
        <div class="info-box">
            <strong>Store Information:</strong>
            <ul>
                <li>Store ID: <code>6545032</code></li>
                <li>Widget Script: <code id="script-source">Loading...</code></li>
                <li>Environment: <code id="environment">Development</code></li>
                <li>Status: <span id="widget-status">Initializing...</span></li>
            </ul>
        </div>

        <div class="controls">
            <h2>‚öôÔ∏è Widget Controls</h2>
            
            <div class="control-group">
                <label for="trigger-type">Trigger Type:</label>
                <select id="trigger-type">
                    <option value="delay">Delay (seconds)</option>
                    <option value="immediate">Immediate</option>
                    <option value="scroll">On Scroll</option>
                    <option value="exit_intent">Exit Intent</option>
                    <option value="click">On Click</option>
                </select>
            </div>

            <div class="control-group" id="delay-control">
                <label for="delay-seconds">Delay (seconds):</label>
                <input type="number" id="delay-seconds" value="2" min="1" max="60">
            </div>

            <div class="control-group">
                <label for="test-mode">
                    <input type="checkbox" id="test-mode" checked> Test Mode (bypass session checks)
                </label>
            </div>

            <div class="control-group">
                <label for="api-url">API URL:</label>
                <select id="api-url">
                    <option value="local">Local (http://localhost:5173)</option>
                    <option value="production">Production (https://www.rooleta.com)</option>
                </select>
            </div>

            <button class="btn" onclick="reloadWidget()">üîÑ Reload Widget</button>
            <button class="btn" onclick="showWidget()">üëÅÔ∏è Show Widget</button>
            <button class="btn" onclick="resetSession()">üóëÔ∏è Reset Session</button>
            <button class="btn btn-danger" onclick="clearConsole()">üßπ Clear Console</button>
        </div>

        <div class="status info" id="status-message">
            Widget will load based on selected configuration...
        </div>

        <div class="product-grid">
            <div class="product-card">
                <div class="product-image"></div>
                <h3>Producto de Ejemplo 1</h3>
                <p class="price">$1,299</p>
                <button class="btn coolpops-trigger">Comprar Ahora</button>
            </div>
            <div class="product-card">
                <div class="product-image"></div>
                <h3>Producto de Ejemplo 2</h3>
                <p class="price">$899</p>
                <button class="btn coolpops-trigger">Comprar Ahora</button>
            </div>
            <div class="product-card">
                <div class="product-image"></div>
                <h3>Producto de Ejemplo 3</h3>
                <p class="price">$1,999</p>
                <button class="btn coolpops-trigger">Comprar Ahora</button>
            </div>
        </div>

        <h2>üìä Console Output</h2>
        <div class="console-output" id="console-output">
            <div class="console-line info">Console initialized...</div>
        </div>
    </div>

    <script>
        // Store the original console methods
        const originalConsole = {
            log: console.log,
            error: console.error,
            warn: console.warn,
            info: console.info
        };

        // Custom console output
        const consoleOutput = document.getElementById('console-output');
        
        function addConsoleMessage(type, args) {
            const line = document.createElement('div');
            line.className = `console-line ${type}`;
            const timestamp = new Date().toLocaleTimeString();
            const message = Array.from(args).map(arg => {
                if (typeof arg === 'object') {
                    try {
                        return JSON.stringify(arg, null, 2);
                    } catch (e) {
                        return String(arg);
                    }
                }
                return String(arg);
            }).join(' ');
            line.textContent = `[${timestamp}] ${message}`;
            consoleOutput.appendChild(line);
            consoleOutput.scrollTop = consoleOutput.scrollHeight;
        }

        // Override console methods to capture output
        console.log = function(...args) {
            originalConsole.log.apply(console, args);
            addConsoleMessage('info', args);
        };
        
        console.error = function(...args) {
            originalConsole.error.apply(console, args);
            addConsoleMessage('error', args);
        };
        
        console.warn = function(...args) {
            originalConsole.warn.apply(console, args);
            addConsoleMessage('warn', args);
        };
        
        console.info = function(...args) {
            originalConsole.info.apply(console, args);
            addConsoleMessage('info', args);
        };

        // Widget configuration
        let widgetScript = null;
        
        function getWidgetConfig() {
            const apiUrl = document.getElementById('api-url').value;
            const triggerType = document.getElementById('trigger-type').value;
            const delaySeconds = document.getElementById('delay-seconds').value;
            const testMode = document.getElementById('test-mode').checked;
            
            const baseUrl = apiUrl === 'local' ? 'http://localhost:5173' : 'https://www.rooleta.com';
            
            return {
                scriptUrl: `${baseUrl}/tiendanube-widget.js`,
                apiUrl: baseUrl,
                trigger: triggerType,
                delay: delaySeconds,
                testMode: testMode
            };
        }

        function updateStatus(message, type = 'info') {
            const statusEl = document.getElementById('status-message');
            statusEl.textContent = message;
            statusEl.className = `status ${type}`;
            document.getElementById('widget-status').textContent = message;
        }

        function loadWidget() {
            // Remove existing widget script if any
            if (widgetScript) {
                widgetScript.remove();
                // Reset the global flag
                window.__coolPopsInitialized = false;
                // Clear widget-related session storage
                Object.keys(sessionStorage).filter(k => k.includes('coolpops')).forEach(k => sessionStorage.removeItem(k));
            }
            
            const config = getWidgetConfig();
            
            // Update display
            document.getElementById('script-source').textContent = config.scriptUrl;
            document.getElementById('environment').textContent = config.apiUrl.includes('localhost') ? 'Development' : 'Production';
            
            // Create and load the widget script
            widgetScript = document.createElement('script');
            widgetScript.src = config.scriptUrl;
            widgetScript.setAttribute('data-store-id', '6545032');
            widgetScript.setAttribute('data-trigger', config.trigger);
            widgetScript.setAttribute('data-delay', config.delay);
            widgetScript.setAttribute('data-test', config.testMode);
            widgetScript.setAttribute('data-api-url', config.apiUrl);
            
            widgetScript.onload = function() {
                console.log('[Test Page] Widget script loaded successfully');
                updateStatus('Widget loaded successfully', 'success');
            };
            
            widgetScript.onerror = function() {
                console.error('[Test Page] Failed to load widget script');
                updateStatus('Failed to load widget script', 'error');
            };
            
            console.log('[Test Page] Loading widget with configuration:', config);
            document.head.appendChild(widgetScript);
        }

        function reloadWidget() {
            console.log('[Test Page] Reloading widget...');
            updateStatus('Reloading widget...', 'info');
            loadWidget();
        }

        function showWidget() {
            if (window.CoolPopsWidget && window.CoolPopsWidget.show) {
                console.log('[Test Page] Manually showing widget');
                window.CoolPopsWidget.show();
            } else {
                console.error('[Test Page] Widget not loaded or show function not available');
                updateStatus('Widget not loaded', 'error');
            }
        }

        function resetSession() {
            console.log('[Test Page] Resetting session...');
            if (window.CoolPopsWidget && window.CoolPopsWidget.reset) {
                window.CoolPopsWidget.reset();
            } else {
                // Manual reset
                Object.keys(sessionStorage).filter(k => k.includes('coolpops')).forEach(k => {
                    sessionStorage.removeItem(k);
                    console.log(`[Test Page] Removed session key: ${k}`);
                });
            }
            updateStatus('Session reset complete', 'success');
        }

        function clearConsole() {
            consoleOutput.innerHTML = '<div class="console-line info">Console cleared...</div>';
        }

        // Handle trigger type changes
        document.getElementById('trigger-type').addEventListener('change', function(e) {
            const delayControl = document.getElementById('delay-control');
            delayControl.style.display = e.target.value === 'delay' ? 'block' : 'none';
        });

        // Simulate TiendaNube LS object (minimal)
        window.LS = {
            store: {
                id: '6545032',
                name: 'Test Store 6545032',
                currency: 'ARS',
                language: 'es'
            },
            event: {
                on: function(event, callback) {
                    console.log(`[Test Page] LS event registered: ${event}`);
                }
            }
        };

        // Initial load
        window.addEventListener('DOMContentLoaded', function() {
            console.log('[Test Page] DOM loaded, initializing widget...');
            loadWidget();
        });

        // Add scroll content for scroll trigger testing
        for (let i = 0; i < 3; i++) {
            const spacer = document.createElement('div');
            spacer.style.height = '500px';
            spacer.innerHTML = `<p style="text-align: center; color: #999; margin-top: 200px;">Scroll down to test scroll trigger...</p>`;
            document.body.appendChild(spacer);
        }
    </script>
</body>
</html>